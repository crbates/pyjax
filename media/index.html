<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Flot Examples</title>
    <link href="/media/layout.css" rel="stylesheet" type="text/css">
    <!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../excanvas.min.js"></script><![endif]-->
    <script language="javascript" type="text/javascript" src="/media/flot/jquery.js"></script>
    <script language="javascript" type="text/javascript" src="/media/flot/jquery.flot.js"></script>
    <script language="javascript" type="text/javascript" src="/media/flot/jquery.flot.selection.js"></script>
 </head>
    <body>
    <h1>Flot Examples</h1>

    <div id="placeholder" style="width:600px;height:300px;"></div>

    <p>livetime: <span id="livetime"></span></p> 
    <p>
    Upload an Ascii spe file:
    <form action="upload" method="post" enctype="multipart/form-data">
    filename: <input type="file" name="myFile" />
    <input type="submit" />
    </form>
    </p>
    <p>You selected: <span id="selection"></span></p>
    <p><input id="addcalpoint" type="button" value="Add a calibration point at selected peak"> </p>
    <div id="calpoints"></div>
    <div id="success"></div>
    <!-- <p>Time between updates: <input id="updateInterval" type="text" value="" style="text-align: right; width:5em"> milliseconds</p> -->

<script type="text/javascript">
$(function () {
    // we use an inline data source in the example, usually data would
    // be fetched from a server
    var data = [], totalPoints = 300;
    var energy = [];
    var y = 0;
    var npoints = 0;
    var ready = false;
   
    function getRandomData() {
        if (data.length == 0){           
            // do a random walk
            while (data.length < totalPoints) {
                var prev = data.length > 0 ? data[data.length - 1] : 50;
                y = prev + Math.random() * 10 - 5;
                if (y < 0)
                    y = 0;
                if (y > 100)
                    y = 100;
                
                //$.post('/submit',sety);
                data.push(y);
            }
        }
        
        // zip the generated y values with the x values
        var res = [];
        for (var i = 0; i < data.length; ++i)
            res.push([i, data[i]])
        return res;
    }

    // setup control widget
    /*
    var updateInterval = 300;
    $("#updateInterval").val(updateInterval).change(function () {
        var v = $(this).val();
        if (v && !isNaN(+v)) {
            updateInterval = +v;
            if (updateInterval < 1)
                updateInterval = 1;
            if (updateInterval > 2000)
                updateInterval = 2000;
            $(this).val("" + updateInterval);
        }
    });
    */
    var placeholder = $("#placeholder");

    placeholder.bind("plotselected", function (event, ranges) {
        $("#selection").text(ranges.xaxis.from.toFixed(1) + " to " + ranges.xaxis.to.toFixed(1));
    });
    
    
    // setup plot
    var options = {
        series: { shadowSize: 0 }, // drawing is faster without shadows
        yaxis: { min: 0,autoscaleMargin: 0.1 },
        xaxis: { show: true },
        selection: { mode: "x"}
    };
    var plot = $.plot($("#placeholder"), [ getRandomData() ], options);
    
    
    function updatecal(dat) {
        data = dat['val']
        energy = dat['en']
        $("#livetime").text(dat['livetime']+"s")
        var res = [];
        for (var i = 0; i < data.length; ++i)
            res.push([i, data[i]]);
            
        plot.setData([res]);
        plot.setupGrid()
        plot.draw();
    // Update the spectrum with the new calibration
    }
    
    $("#addcalpoint").click(function() {
        $("#calpoints").html(" element: <input id=\"element\" type=\"text\" value=\"\">\
        <br> mass <input id=\"mass\" type=\"text\" value=\"\">\
        <br> energy <input id=\"energy\" type=\"text\" value=\"\">\
        <br> <label><input id=\"save\" type=\"checkbox\" / >Save point.</label>  ");
        ready = true;
        $.post('/cal',{minv:ranges.xaxis.from.toFixed(1),maxv:ranges.xaxis.to.toFixed(1),energy:$("#energy").txt},updatecal)
    
    });
    
    function checkval() {
        if(ready) {
            $('#success').text("val is: " + $("#element").val());
            var save = $('#save').attr("checked");
            if (save) {
                $.post()
            }
            
        }
        setTimeout(checkval,100);
    }
    
    function update() {
        //plot = $.plot($("#placeholder"), [ getRandomData() ], options);
        plot.setData([ getRandomData() ]);
        plot.setupGrid()
        plot.draw();
        
        //setTimeout(update, updateInterval);
    }
    $.post('/submit',{name:y},updatecal);
    checkval();
    update();
    
});
</script>

 </body>
</html>
